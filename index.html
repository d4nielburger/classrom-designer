<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Classroom Designer Pro</title>
    <style>
        :root {
            --bg: #f0f2f5;
        }

        body {
            font-family: 'Segoe UI', system-ui, sans-serif;
            background-color: var(--bg);
            margin: 0;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            display: flex;
            flex-direction: column;
            /* viewport height minus body vertical padding (20px top + 20px bottom) */
            height: calc(100vh - 40px);
        }

        #toolbar {
            background: white;
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
            margin-bottom: 20px;
            display: flex;
            gap: 15px;
            align-items: flex-end;
            flex-wrap: wrap;
            flex: 0 0 auto;
        }

        .control-group {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }

        label {
            font-size: 11px;
            font-weight: bold;
            color: #888;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        /* Clean inputs - no blue highlights */
        input,
        button,
        select {
            padding: 8px 10px;
            border: 1px solid #ddd;
            border-radius: 6px;
            outline: none !important;
            height: 38px;
            box-sizing: border-box;
        }

        input:focus,
        select:focus {
            border-color: #bbb;
        }

        button {
            cursor: pointer;
            font-weight: 600;
            transition: 0.2s;
            background: #fff;
        }

        button:hover {
            background: #f8f9fa;
            border-color: #bbb;
        }

        .btn-primary {
            background: #333;
            color: white;
            border: none;
        }

        .btn-primary:hover {
            background: #000;
        }

        .btn-danger {
            background: #fee2e2;
            color: #dc2626;
            border: 1px solid #fecaca;
        }

        /* The Custom Color Pickers */
        .palette-dropdown {
            width: 50px;
            cursor: pointer;
            font-weight: bold;
            text-align: center;
            appearance: none;
        }

        /* Modern color grid */
        .palette-dropdown {
            width: auto;
            position: relative;
        }

        .palette-btn {
            width: 50px;
            height: 38px;
            border-radius: 6px;
            border: 1px solid #ddd;
            display: inline-block;
            vertical-align: middle;
            cursor: pointer;
        }

        .color-grid {
            position: absolute;
            top: 48px;
            left: 0;
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            gap: 8px;
            padding: 10px;
            background: white;
            border-radius: 8px;
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.12);
            z-index: 50;
            width: 220px;
        }

        .color-grid.hidden {
            display: none;
        }

        .swatch {
            width: 34px;
            height: 34px;
            border-radius: 6px;
            cursor: pointer;
            border: 2px solid rgba(0, 0, 0, 0.06);
            box-sizing: border-box;
            transition: transform 0.08s ease, box-shadow 0.08s ease;
        }

        .swatch:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 14px rgba(0, 0, 0, 0.12);
        }

        .swatch.selected {
            outline: 2px solid #fff;
            box-shadow: 0 0 0 3px rgba(0, 0, 0, 0.06) inset;
        }

        /* Classroom Setup */
        #classroom-container {
            position: relative;
            background: white;
            border: 2px solid #333;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
            flex: 1 1 auto;
        }

        #grid-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: grid;
            pointer-events: none;
            z-index: 1;
        }

        .grid-cell {
            border: 0.5px solid #f0f0f0;
        }

        #classroom {
            position: relative;
            width: 100%;
            height: 100%;
            z-index: 2;
            overflow: hidden;
        }

        /* The Desk Card */
        .desk {
            position: absolute;
            color: white;
            border-radius: 8px;
            cursor: move;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.15);
            z-index: 10;
            border: 2px solid rgba(0, 0, 0, 0.1);
            box-sizing: border-box;
        }

        .name-edit {
            background: rgba(255, 255, 255, 0.2);
            border: none;
            color: white;
            text-align: center;
            width: 85%;
            font-weight: bold;
            border-radius: 4px;
            padding: 2px;
            font-size: 13px;
            outline: none;
        }

        .desk-controls {
            position: absolute;
            top: 4px;
            right: 4px;
            left: 4px;
            display: flex;
            justify-content: space-between;
            opacity: 0;
            transition: 0.2s;
        }

        .desk:hover .desk-controls {
            opacity: 1;
        }

        .desk-btn {
            background: rgba(0, 0, 0, 0.3);
            border: none;
            color: white;
            width: 20px;
            height: 20px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            appearance: none;
            text-align: center;
        }

        .desk-btn:hover {
            background: rgba(0, 0, 0, 0.6);
        }
    </style>
</head>

<body>

    <div class="container">
        <div id="toolbar">
            <div class="control-group">
                <label>Card Color</label>
                <div id="globalColor" class="palette-dropdown" style="display:flex; align-items:center; gap:8px;">
                    <div id="globalColorBtn" class="palette-btn" title="Select color"></div>
                    <div id="globalPaletteGrid" class="color-grid hidden" aria-hidden="true"></div>
                </div>
            </div>

            <div class="control-group">
                <label>Student Name</label>
                <div style="display:flex; gap:5px;">
                    <input type="text" id="newName" placeholder="Enter name..."
                        onkeydown="if(event.key==='Enter') addStudent()">
                    <button class="btn-primary" onclick="addStudent()">Add Student</button>
                </div>
            </div>

            <div class="control-group">
                <label>Grid Size</label>
                <div style="display:flex; gap:5px;">
                    <input type="number" id="colsInput" value="8" min="2" style="width:55px">
                    <input type="number" id="rowsInput" value="6" min="2" style="width:55px">
                </div>
            </div>

            <div style="flex-grow: 1;"></div>

            <div class="control-group">
                <label>Actions</label>
                <div style="display:flex; gap:5px;">
                    <button onclick="exportToJson()">Export JSON</button>
                    <button onclick="document.getElementById('importFile').click()">Import JSON</button>
                    <button class="btn-danger" onclick="clearAll()">Clear All</button>
                    <input type="file" id="importFile" hidden accept=".json">
                </div>
            </div>
        </div>

        <div id="classroom-container">
            <div id="grid-overlay"></div>
            <div id="classroom"></div>
        </div>
    </div>

    <script>
        // Core DOM refs
        const classroom = document.getElementById('classroom');
        const overlay = document.getElementById('grid-overlay');
        const colsInput = document.getElementById('colsInput');
        const rowsInput = document.getElementById('rowsInput');
        const globalColorPicker = document.getElementById('globalColor');
        const globalPaletteGrid = document.getElementById('globalPaletteGrid');
        const globalColorBtn = document.getElementById('globalColorBtn');

        let students = [];
        let currentPopover = null; // track the open desk popover
        let config = { cols: 8, rows: 6 };

        // 25-color palette (5x5)
        const palette = [
            "#f44336", "#e91e63", "#9c27b0", "#673ab7", "#3f51b5",
            "#2196f3", "#03a9f4", "#00bcd4", "#009688", "#4caf50",
            "#8bc34a", "#cddc39", "#ffeb3b", "#ffc107", "#ff9800",
            "#ff5722", "#795548", "#9e9e9e", "#607d8b", "#000000",
            "#ffffff", "#f06292", "#ba68c8", "#4db6ac", "#ffd54f"
        ];

        let globalSelectedColor = palette[0];

        /**
         * Initialize the UI and restore saved state.
         * - builds the global palette
         * - restores saved classroom from localStorage (if any)
         * - wires global event handlers
         */
        window.onload = () => {
            // Build the global modern palette (5x5)
            palette.forEach(color => {
                const s = document.createElement('div');
                s.className = 'swatch';
                s.style.backgroundColor = color;
                s.title = color;
                s.onclick = (e) => {
                    e.stopPropagation();
                    globalSelectedColor = color;
                    globalColorBtn.style.backgroundColor = color;
                    // highlight selection
                    Array.from(globalPaletteGrid.children).forEach(c => c.classList.remove('selected'));
                    s.classList.add('selected');
                };
                globalPaletteGrid.appendChild(s);
            });

            // initialize global color button and behavior
            globalColorBtn.style.backgroundColor = globalSelectedColor;
            globalColorBtn.onclick = (e) => { e.stopPropagation(); globalPaletteGrid.classList.toggle('hidden'); };
            document.addEventListener('click', () => globalPaletteGrid.classList.add('hidden'));
            globalPaletteGrid.addEventListener('click', (e) => e.stopPropagation());

            const saved = localStorage.getItem('classroom_v3');
            if (saved) {
                const data = JSON.parse(saved);
                config = data.config;
                students = data.students;
                colsInput.value = config.cols;
                rowsInput.value = config.rows;
            }
            refreshUI();
        };

        /**
         * Refresh layout and persist state.
         * - re-renders grid & desks
         * - saves to localStorage
         */
        function refreshUI() {
            renderGrid();
            renderDesks();
            saveToLocal();
        }

        /**
         * Render the grid overlay based on current config.cols/config.rows.
         */
        function renderGrid() {
            config.cols = parseInt(colsInput.value) || 8;
            config.rows = parseInt(rowsInput.value) || 6;
            overlay.style.gridTemplateColumns = `repeat(${config.cols}, 1fr)`;
            overlay.style.gridTemplateRows = `repeat(${config.rows}, 1fr)`;
            overlay.innerHTML = Array(config.cols * config.rows).fill('<div class="grid-cell"></div>').join('');
        }

        /**
         * Find the next available cell (row-major order).
         * Returns {col,row} or null when grid is full.
         */
        function findNextAvailablePosition() {
            for (let r = 0; r < config.rows; r++) {
                for (let c = 0; c < config.cols; c++) {
                    if (!students.some(s => s.col === c && s.row === r)) {
                        return { col: c, row: r };
                    }
                }
            }
            return null;
        }

        /**
         * Add a new student card at the next available position.
         * Uses current globalSelectedColor for the card color.
         */
        function addStudent() {
            const input = document.getElementById('newName');
            if (!input.value.trim()) return;

            // ensure we use current grid dimensions
            config.cols = parseInt(colsInput.value) || config.cols;
            config.rows = parseInt(rowsInput.value) || config.rows;

            const pos = findNextAvailablePosition();
            if (!pos) {
                alert('No available positions in the grid. Increase grid size or remove a student.');
                return;
            }

            students.push({
                id: Date.now() + Math.random(),
                name: input.value,
                color: globalSelectedColor,
                col: pos.col,
                row: pos.row
            });
            input.value = '';
            refreshUI();
        }

        /**
         * Render all student desk elements.
         * Each desk includes a small color icon button and delete button.
         */
        function renderDesks() {
            classroom.innerHTML = '';
            const cellW = classroom.offsetWidth / config.cols;
            const cellH = classroom.offsetHeight / config.rows;

            students.forEach((s) => {
                const el = document.createElement('div');
                el.className = 'desk';
                el.style.backgroundColor = s.color;
                el.style.width = (cellW - 10) + 'px';
                el.style.height = (cellH - 10) + 'px';
                el.style.left = (s.col * cellW + 5) + 'px';
                el.style.top = (s.row * cellH + 5) + 'px';

                const controls = document.createElement('div');
                controls.className = 'desk-controls';

                // compact icon button for color selection (keeps visible on any desk color)
                const colorBtn = document.createElement('button');
                colorBtn.className = 'desk-btn';
                colorBtn.style.width = '20px';
                colorBtn.style.height = '20px';
                colorBtn.style.padding = '0';
                colorBtn.style.borderRadius = '4px';
                colorBtn.title = 'Change color';
                colorBtn.style.backgroundColor = 'rgba(255,255,255,0.15)';
                colorBtn.style.backdropFilter = 'blur(2px)';
                colorBtn.innerHTML = '<svg width="12" height="12" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" style="display:block;margin:auto;"><path d="M2 22l3-1 1-3L8 20l3-3 7-7a2 2 0 10-2.828-2.828L8 14l-3 3 1 2-3 1-1 3z" stroke="#111" stroke-width="1.2" stroke-linecap="round" stroke-linejoin="round"/></svg>';

                // open per-desk popover; ensure only one popover exists
                colorBtn.onclick = (ev) => {
                    ev.stopPropagation();
                    if (currentPopover) {
                        try { document.body.removeChild(currentPopover); } catch {}
                        currentPopover = null;
                    }

                    const pop = document.createElement('div');
                    pop.className = 'color-grid';
                    pop.style.position = 'absolute';
                    pop.style.zIndex = 9999;

                    palette.forEach(color => {
                        const sw = document.createElement('div');
                        sw.className = 'swatch';
                        sw.style.backgroundColor = color;
                        sw.onclick = (e) => {
                            e.stopPropagation();
                            s.color = color;
                            el.style.backgroundColor = color;
                            try { document.body.removeChild(pop); } catch {}
                            currentPopover = null;
                            saveToLocal();
                        };
                        pop.appendChild(sw);
                    });

                    // position popover near button (clamped)
                    const rect = colorBtn.getBoundingClientRect();
                    const left = Math.max(8, Math.min(rect.left, window.innerWidth - 240));
                    const top = rect.bottom + 8;
                    pop.style.left = left + 'px';
                    pop.style.top = top + 'px';

                    // close when clicking outside
                    const onDoc = (e) => {
                        if (!pop.contains(e.target)) {
                            try { document.body.removeChild(pop); } catch {}
                            document.removeEventListener('click', onDoc);
                            currentPopover = null;
                        }
                    };
                    setTimeout(() => document.addEventListener('click', onDoc), 0);

                    document.body.appendChild(pop);
                    currentPopover = pop;
                };
                colorBtn.onmousedown = (e) => e.stopPropagation();

                // delete button
                const delBtn = document.createElement('button');
                delBtn.className = 'desk-btn';
                delBtn.innerHTML = 'âœ•';
                delBtn.onclick = (e) => {
                    e.stopPropagation();
                    students = students.filter(student => student.id !== s.id);
                    refreshUI();
                };
                delBtn.onmousedown = (e) => e.stopPropagation();

                controls.appendChild(colorBtn);
                controls.appendChild(delBtn);

                const nameInput = document.createElement('input');
                nameInput.className = 'name-edit';
                nameInput.value = s.name;
                nameInput.onchange = (e) => { s.name = e.target.value; saveToLocal(); };
                nameInput.onmousedown = (e) => e.stopPropagation();

                el.appendChild(controls);
                el.appendChild(nameInput);
                makeDraggable(el, s, cellW, cellH);
                classroom.appendChild(el);
            });
        }

        /**
         * Enable dragging of desk elements and snap them to grid on drop.
         * Parameters:
         *  - el: element to drag
         *  - studentObj: reference to the student model to update col/row
         *  - cellW/cellH: current cell dimensions for snapping
         */
        function makeDraggable(el, studentObj, cellW, cellH) {
            el.onmousedown = (e) => {
                if (e.target.tagName === 'INPUT' || e.target.tagName === 'SELECT' || e.target.tagName === 'BUTTON') return;

                const startX = e.clientX;
                const startY = e.clientY;
                const origX = el.offsetLeft;
                const origY = el.offsetTop;

                document.onmousemove = (e) => {
                    el.style.left = (origX + (e.clientX - startX)) + "px";
                    el.style.top = (origY + (e.clientY - startY)) + "px";
                    el.style.zIndex = 1000;
                };

                document.onmouseup = () => {
                    document.onmousemove = null;
                    document.onmouseup = null;
                    let col = Math.round((el.offsetLeft) / cellW);
                    let row = Math.round((el.offsetTop) / cellH);
                    studentObj.col = Math.max(0, Math.min(col, config.cols - 1));
                    studentObj.row = Math.max(0, Math.min(row, config.rows - 1));
                    refreshUI();
                };
            };
        }

        /**
         * Export current layout to a JSON file.
         */
        function exportToJson() {
            const data = { config, students };
            const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
            const a = document.createElement('a');
            a.href = URL.createObjectURL(blob);
            a.download = `classroom_layout.json`;
            a.click();
        }

        /**
         * Import handler for JSON file input.
         */
        document.getElementById('importFile').onchange = (e) => {
            const reader = new FileReader();
            reader.onload = (ev) => {
                const data = JSON.parse(ev.target.result);
                config = data.config; students = data.students;
                colsInput.value = config.cols; rowsInput.value = config.rows;
                refreshUI();
            };
            reader.readAsText(e.target.files[0]);
        };

        /**
         * Persist current config and students to localStorage.
         */
        function saveToLocal() {
            localStorage.setItem('classroom_v3', JSON.stringify({ config, students }));
        }

        /**
         * Remove all students after confirmation.
         */
        function clearAll() {
            if (confirm("Clear the entire classroom?")) {
                students = [];
                refreshUI();
            }
        }

        // Wire resize and grid-size change handlers
        window.onresize = refreshUI;
        [colsInput, rowsInput].forEach(i => i.onchange = refreshUI);
    </script>

</body>

</html>